<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no" />
  <title>wazder's spotify controller</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      background-color: #000; color: #fff; font-family: Arial, sans-serif;
    }
    /* LOGIN */
    #loginContainer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding-top: 20vh;
    }
    #loginContainer h1 {
      margin-bottom: 20px; font-size: 2rem; text-align: center;
    }
    #loginBtn {
      padding: 12px 24px; font-size: 1.2rem; border: none;
      border-radius: 4px; background-color: #1DB954; color: #fff; cursor: pointer;
    }
    /* APP */
    #app { display: none; padding: 20px; height: 100%; box-sizing: border-box; }
    /* Now Playing */
    #nowPlaying {
      display: flex; align-items: center; gap: 16px;
      background-color: #333; border-radius: 8px; padding: 10px;
      margin-bottom: 20px;
    }
    #coverArt {
      width: 64px; height: 64px; background-color: #222;
      background-size: cover; background-position: center;
      border-radius: 4px;
    }
    #trackInfo {
      flex: 1; display: flex; flex-direction: column;
    }
    #trackInfo h2 {
      margin: 0; font-size: 1.2rem; white-space: nowrap;
      overflow: hidden;
    }
    #positionDisplay { font-size: 0.9rem; margin-top: 4px; }
    #progressBar {
      width: 100%; height: 4px; background-color: #444;
      border-radius: 2px; overflow: hidden; margin-top: 8px;
    }
    #progress { width: 0; height: 100%; background-color: #666; border-radius: 2px; }
    #controls { display: flex; align-items: center; gap: 10px; margin-left: auto; }
    #moreBtn, #prevBtn, #nextBtn {
      background: transparent; border: none; color: #fff; cursor: pointer;
    }
    #moreBtn { padding: 6px 12px; font-size: 0.9rem; background-color: #555; border-radius: 4px; }
    /* Columns */
    #containers { display: flex; gap: 20px; height: calc(100% - 140px); }
    .column { flex: 1; background-color: #111; padding: 10px;
      border-radius: 4px; overflow-y: auto;
    }
    .column h3 { margin-top: 0; font-size: 1rem; }
    .item {
      padding: 8px; margin-bottom: 4px; border: 1px solid #333;
      border-radius: 4px; cursor: pointer; display: flex; align-items: center;
    }
    .item.playing { background-color: #1DB954; color: #000; }
    .item.selected { border-color: brown; }
    .item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item .desc { color: rgba(255, 255, 255, 0.5); margin-left: 4px; }
    .show-more {
      display: block; width: 100%; padding: 8px; margin-top: 8px;
      text-align: center; background: none; border: 1px solid #1DB954;
      color: #1DB954; border-radius: 4px; cursor: pointer;
    }
    #infoColumn, #lyricsColumn { display: none; }
    /* Footer */
    #footer {
      position: fixed; bottom: 10px; right: 10px;
      font-size: 0.8rem; color: rgba(255,255,255,0.3);
      pointer-events: none; z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="loginContainer">
    <h1>welcome to wazder's spotify controller</h1>
    <button id="loginBtn">Spotify Login</button>
  </div>

  <div id="app">
    <div id="nowPlaying">
      <div id="coverArt"></div>
      <div id="trackInfo">
        <h2 id="nowArtist">—</h2>
        <h2 id="nowAlbumTrack">—</h2>
        <div id="positionDisplay">00:00 / 00:00</div>
        <div id="progressBar"><div id="progress"></div></div>
      </div>
      <div id="controls">
        <button id="moreBtn">More</button>
        <button id="prevBtn">⏮</button>
        <button id="nextBtn">⏭</button>
      </div>
    </div>

    <div id="containers">
      <div class="column" id="playlistColumn">
        <h3>Playlists</h3>
        <div id="playlistContainer"></div>
      </div>
      <div class="column" id="trackColumn">
        <h3>Tracks</h3>
        <div id="trackContainer"></div>
      </div>
      <div class="column" id="infoColumn">
        <h3>Track Info</h3>
        <p id="infoArtist">—</p>
        <p id="infoAlbumTrack">—</p>
      </div>
      <div class="column" id="lyricsColumn">
        <h3>Lyrics</h3>
        <div id="lyricsContainer"></div>
      </div>
    </div>
  </div>

  <div id="footer">made by wazder with love <3</div>

  <script>
    let playlists = [], nextPlaylistsUrl = null;
    let tracks = [], nextTracksUrl = null;
    let selectedPlaylistId = '', playingContextUri = '';
    let currentIndex = 0, currentDuration = 0, lyrics = [];
    let updateInterval = null, view = 'tracks';

    function formatMS(ms) {
      const s = Math.floor(ms/1000)%60, m = Math.floor(ms/60000);
      return `${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
    }
    function switchView(v) {
      view = v;
      ['trackColumn','infoColumn','lyricsColumn'].forEach(id => {
        document.getElementById(id).style.display = (id === v+'Column') ? 'block' : 'none';
      });
    }
    document.getElementById('moreBtn').onclick = () => {
      if(view === 'tracks') switchView('lyrics');
      else switchView('tracks');
    };

    (async()=>{
      const params = new URLSearchParams(window.location.search), code = params.get('code');
      if(!code) return;
      const cid = '46a1e07e779c46998b413317a78b8a26', uri = window.location.origin + window.location.pathname;
      const vr = localStorage.getItem('spotify_code_verifier');
      const body = new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:uri,client_id:cid,code_verifier:vr});
      const res = await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body});
      const data = await res.json(); if(!data.access_token){alert('Token alınamadı');return;}
      window.history.replaceState({},'',window.location.pathname);
      window.accessToken = data.access_token;
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      fetchPlaylists();
    })();

    document.getElementById('loginBtn').onclick = async()=>{/* PKCE login unchanged */};

    function fetchPlaylists(url) {
      fetch(url||'https://api.spotify.com/v1/me/playlists?limit=50',{headers:{Authorization:'Bearer '+window.accessToken}})
        .then(r=>r.json()).then(d=>{playlists.push(...d.items);nextPlaylistsUrl=d.next;renderPlaylists();});
    }

    function renderPlaylists() {
      const c = document.getElementById('playlistContainer'); c.innerHTML = '';
      playlists.forEach((pl)=>{
        const div = document.createElement('div');
        div.className = 'item' +
          ((pl.id===selectedPlaylistId && pl.id===playingContextUri)?' playing':'') +
          (pl.id===selectedPlaylistId?' selected':'');
        const sp = document.createElement('span'); sp.textContent = pl.name; div.appendChild(sp);
        if(pl.description){const ds=document.createElement('span');ds.className='desc';ds.textContent=', '+pl.description;div.appendChild(ds);}        
        div.onclick = ()=> selectPlaylist(pl);
        c.appendChild(div);
      });
    }

    function selectPlaylist(pl) {
      selectedPlaylistId = pl.id;
      tracks = []; nextTracksUrl = null;
      switchView('tracks');
      renderPlaylists();
      fetchTracks(`https://api.spotify.com/v1/playlists/${pl.id}/tracks?limit=50`);
    }

    function fetchTracks(url) {
      fetch(url,{headers:{Authorization:'Bearer '+window.accessToken}})
        .then(r=>r.json()).then(d=>{tracks.push(...d.items);renderTracks();});
    }

    function renderTracks() {
      const c = document.getElementById('trackContainer'); c.innerHTML = '';
      tracks.forEach((it,idx)=>{
        const t = it.track;
        const div = document.createElement('div');
        if(selectedPlaylistId===playingContextUri && idx===currentIndex) div.className='item playing';
        else div.className='item';
        const sp = document.createElement('span'); sp.textContent = t.name; div.appendChild(sp);
        div.onclick = ()=> playTrack(idx);
        c.appendChild(div);
      });
    }

    async function playTrack(idx) {
      const t = tracks[idx].track; currentIndex=idx; currentDuration=t.duration_ms;
      await fetch('https://api.spotify.com/v1/me/player/play',{method:'PUT',headers:{Authorization:'Bearer '+window.accessToken,'Content-Type':'application/json'},body:JSON.stringify({context_uri:`spotify:playlist:${selectedPlaylistId}`,offset:{position:idx}})});
      playingContextUri = selectedPlaylistId;
      document.getElementById('nowArtist').textContent = t.artists.map(a=>a.name).join(', ');
      document.getElementById('nowAlbumTrack').textContent = `${t.album.name} - ${t.name}`;
      document.getElementById('coverArt').style.backgroundImage = `url(${t.album.images[0]?.url})`;
      document.getElementById('infoArtist').textContent = t.artists.map(a=>a.name).join(', ');
      document.getElementById('infoAlbumTrack').textContent = `${t.album.name} - ${t.name}`;
      renderPlaylists(); renderTracks();
      clearInterval(updateInterval);
      document.getElementById('positionDisplay').textContent = `00:00 / ${formatMS(t.duration_ms)}`;
      updateInterval = setInterval(updatePosition,1000);
    }

    function updatePosition() {
      fetch('https://api.spotify.com/v1/me/player',{headers:{Authorization:'Bearer '+window.accessToken}})
        .then(r=>r.json()).then(s=>{
          const e=s.progress_ms||0;
          if(e>=currentDuration){playTrack((currentIndex+1)%tracks.length);return;}
          document.getElementById('positionDisplay').textContent = `${formatMS(e)} / ${formatMS(currentDuration)}`;
          document.getElementById('progress').style.width = `${(e/currentDuration)*100}%`;
        });
    }

    document.getElementById('prevBtn').onclick = ()=> playTrack((currentIndex-1+tracks.length)%tracks.length);
    document.getElementById('nextBtn').onclick = ()=> playTrack((currentIndex+1)%tracks.length);
  </script>
</body>
</html>
