<!-- File: index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
  <title>wazder Spotify Player</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #000; color: #fff; position: relative; }
    #containers { display: flex; gap: 20px; }
    #playlistContainer, #trackContainer { width: 300px; max-height: 400px; overflow-y: auto; background-color: #111; padding: 10px; border-radius: 4px; }
    .playlist-item, .track-item { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 5px; border: 2px solid #333; border-radius: 4px; position: relative; cursor: pointer; overflow: hidden; }
    .playlist-item span, .track-item span { display: inline-block; white-space: nowrap; }
    .playlist-item.playing-playlist { border-color: #1DB954; }
    .playlist-item.playing-playlist::after { content: " üîä"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
    .playlist-item.selected-playlist { border-color: brown; }
    .playlist-item.selected-playlist::after { content: " üìÇ"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
    .playlist-item.playing-playlist.selected-playlist { background-color: #1DB954; color: #000; border-color: #1DB954; }
    .playlist-item.playing-playlist.selected-playlist::after { content: " üîäüìÇ"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
    .track-item.playing-track { background-color: #1DB954; color: #000; }
    .track-item.playing-track::after { content: " ‚ñ∂Ô∏è"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
    button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 4px; background-color: #1DB954; color: #fff; cursor: pointer; }
    #prevButton, #nextButton { position: absolute; top: 20px; }
    #prevButton { right: 120px; }
    #nextButton { right: 20px; }
    @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
    .playlist-item:hover span, .track-item:hover span, .playlist-item.playing-playlist span, .track-item.playing-track span { animation: marquee 5s linear infinite; }
  </style>
</head>
<body>
  <button id="loginBtn">Spotify Login</button>
  <div id="app" style="display:none;">
    <h2>Playliste Connection works</h2>
    <div id="containers">
      <div><h3>Playlists</h3><div id="playlistContainer"></div></div>
      <div><h3>Tracks</h3><div id="trackContainer"></div></div>
    </div>
    <button id="prevButton">Previous</button>
    <button id="nextButton">Next</button>
  </div>
<script>
  let playlists = [], currentTracks = [];
  let selectedPlaylistId = '', playingPlaylistId = '';
  let currentTrackUri = '', currentIndex = 0;

  function generateRandomString(len) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = ''; for (let i = 0; i < len; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
    return result;
  }
  async function sha256(str) {
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    const b64 = btoa(String.fromCharCode(...new Uint8Array(hash)));
    return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  (async function() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;
    const clientId = '46a1e07e779c46998b413317a78b8a26';
    const redirectUri = window.location.origin + window.location.pathname;
    const verifier = localStorage.getItem('spotify_code_verifier');
    try {
      const body = new URLSearchParams({ grant_type: 'authorization_code', code, redirect_uri: redirectUri, client_id: clientId, code_verifier: verifier });
      const resp = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString() });
      const data = await resp.json(); if (!data.access_token) throw data;
      window.history.replaceState({}, '', window.location.pathname);
      window.accessToken = data.access_token;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      fetchPlaylists();
    } catch (e) { console.error(e); alert('Token alƒ±namadƒ±.'); }
  })();

  document.getElementById('loginBtn').addEventListener('click', async () => {
    const clientId = '46a1e07e779c46998b413317a78b8a26';
    const redirectUri = window.location.origin + window.location.pathname;
    const state = generateRandomString(16);
    const verifier = generateRandomString(64);
    localStorage.setItem('spotify_code_verifier', verifier);
    const challenge = await sha256(verifier);
    const scope = 'playlist-read-private user-modify-playback-state';
    const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${encodeURIComponent(clientId)}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(redirectUri)}&state=${encodeURIComponent(state)}&code_challenge=${encodeURIComponent(challenge)}&code_challenge_method=S256`;
    window.location = authUrl;
  });

  function fetchPlaylists() {
    fetch('https://api.spotify.com/v1/me/playlists?limit=50', { headers: { 'Authorization': 'Bearer ' + window.accessToken } })
      .then(res => res.ok ? res.json() : res.json().then(e => Promise.reject(e.error.message || res.status)))
      .then(data => { playlists = data.items; renderPlaylists(); })
      .catch(err => { console.error(err); alert('Playlist y√ºklenemedi: ' + err); });
  }

  function renderPlaylists() {
    const container = document.getElementById('playlistContainer'); container.innerHTML = '';
    playlists.forEach((pl, i) => {
      const div = document.createElement('div'); div.className = 'playlist-item' + (pl.id === playingPlaylistId ? ' playing-playlist' : '') + (pl.id === selectedPlaylistId ? ' selected-playlist' : '');
      const span = document.createElement('span'); span.textContent = `${i+1}. ${pl.name}`;
      div.appendChild(span);
      div.addEventListener('click', () => togglePlaylist(pl.id));
      container.appendChild(div);
    });
    if (!selectedPlaylistId) document.getElementById('trackContainer').innerHTML = '';
  }

  function togglePlaylist(id) {
    if (selectedPlaylistId === id) { selectedPlaylistId = ''; currentTracks = []; renderPlaylists(); document.getElementById('trackContainer').innerHTML = ''; }
    else { selectedPlaylistId = id; loadTracks(id); }
  }

  function loadTracks(id) {
    fetch(`https://api.spotify.com/v1/playlists/${id}/tracks?limit=100`, { headers: { 'Authorization': 'Bearer ' + window.accessToken } })
      .then(res => res.ok ? res.json() : Promise.reject(res.status))
      .then(data => { currentTracks = data.items.map(i => ({ uri: i.track.uri, name: i.track.name })); renderPlaylists(); renderTracks(); })
      .catch(err => { console.error(err); alert('≈ûarkƒ±lar y√ºklenemedi: ' + err); });
  }

  function renderTracks() {
    const container = document.getElementById('trackContainer'); container.innerHTML = '';
    currentTracks.forEach((t, i) => {
      const div = document.createElement('div'); div.className = 'track-item' + (t.uri === currentTrackUri ? ' playing-track' : '');
      const span = document.createElement('span'); span.textContent = `${i+1}. ${t.name}`;
      div.appendChild(span);
      div.addEventListener('click', () => playTrack(i));
      container.appendChild(div);
    });
  }

  async function playTrack(idx) {
    const uri = currentTracks[idx].uri;
    try {
      const resp = await fetch('https://api.spotify.com/v1/me/player/play', { method: 'PUT', headers: { 'Authorization': 'Bearer ' + window.accessToken, 'Content-Type': 'application/json' }, body: JSON.stringify({ uris: [uri] }) });
      if (!resp.ok) throw new Error(resp.status);
      playingPlaylistId = selectedPlaylistId; currentTrackUri = uri; currentIndex = idx; renderPlaylists(); renderTracks();
    } catch (err) { console.error(err); alert('√áalma hatasƒ±: ' + err); }
  }

  document.getElementById('prevButton').addEventListener('click', () => { if (!currentTracks.length) return; playTrack((currentIndex - 1 + currentTracks.length) % currentTracks.length); });
  document.getElementById('nextButton').addEventListener('click', () => { if (!currentTracks.length) return; playTrack((currentIndex + 1) % currentTracks.length); });
</script>
</body>
</html>
