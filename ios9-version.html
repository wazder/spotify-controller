<!-- ios9-version.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no" />
  <title>wazder's spotify controller</title>
  <link rel="icon" href="logo.png" />
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:Arial,sans-serif; }
    #loginContainer { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; transform:translateY(-20%); }
    #loginBtn { padding:12px 24px; font-size:1.2rem; border:none; border-radius:4px; background-color:#1DB954; color:#fff; cursor:pointer; }
    #app { display:none; padding:20px; height:100%; box-sizing:border-box; }
    #nowPlaying { display:flex; align-items:center; background-color:#333; border-radius:8px; padding:10px; margin-bottom:20px; }
    #coverArt { width:64px; height:64px; background-color:#222; border-radius:4px; background-size:cover; background-position:center; margin-right:16px; }
    #trackInfo { margin-right:auto; }
    #trackInfo h2 { margin:0; font-size:1.2rem; white-space:nowrap; overflow:hidden; }
    #positionDisplay { font-size:0.9rem; margin-top:4px; }
    #progressBar { width:100%; height:4px; background-color:#444; border-radius:2px; overflow:hidden; margin-top:8px; }
    #progress { width:0%; height:100%; background-color:#666; border-radius:2px; }
    #controls { display:flex; align-items:center; margin-left:auto; }
    #controls button { margin-left:10px; background:transparent; border:none; color:#fff; font-size:1.2rem; cursor:pointer; }
    #containers { display:flex; height:calc(100% - 140px); }
    .column { flex:1; background:#111; padding:10px; border-radius:4px; overflow-y:auto; margin-right:20px; }
    .column:last-child { margin-right:0; }
    .column h3 { margin-top:0; font-size:1rem; }
    .item { padding:8px; margin-bottom:4px; border:1px solid #333; border-radius:4px; cursor:pointer; display:flex; align-items:center; }
    .item.playing { background:#1DB954; color:#000; }
    .item.selected { border-color:brown; }
    .item span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
    .desc { color:rgba(255,255,255,0.3); margin-left:4px; }
    .show-more { display:block; width:100%; padding:8px; margin-top:8px; text-align:center; background:none; border:1px solid #1DB954; color:#1DB954; border-radius:4px; cursor:pointer; }
    #infoColumn { display:none; }
    #detailCover { width:80%; padding-bottom:80%; background:#222; background-size:cover; background-position:center; border-radius:4px; margin:0 auto 10px; }
    #footer { position:fixed; bottom:10px; right:10px; font-size:0.8rem; color:rgba(255,255,255,0.3); pointer-events:none; z-index:1000; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.min.js"></script>
</head>
<body>
  <div id="loginContainer">
    <h1>welcome to wazder's spotify controller</h1>
    <button id="loginBtn">Spotify Login</button>
  </div>
  <div id="app">
    <div id="nowPlaying">
      <div id="coverArt"></div>
      <div id="trackInfo">
        <h2 id="nowTitle">—</h2>
        <div id="positionDisplay">00:00 / 00:00</div>
        <div id="progressBar"><div id="progress"></div></div>
      </div>
      <div id="controls">
        <button id="moreBtn">•••</button>
        <button id="prevBtn">⏮</button>
        <button id="nextBtn">⏭</button>
      </div>
    </div>
    <div id="containers">
      <div class="column" id="playlistColumn">
        <h3>Playlists</h3>
        <div id="playlistContainer"></div>
        <button id="morePlaylistsBtn" class="show-more">Show More</button>
      </div>
      <div class="column" id="trackColumn">
        <h3>Tracks</h3>
        <div id="trackContainer"></div>
        <button id="moreTracksBtn" class="show-more">Show More</button>
      </div>
      <div class="column" id="infoColumn">
        <h3>Track Info</h3>
        <div id="detailCover"></div>
        <p id="detailInfo">—</p>
      </div>
    </div>
  </div>
  <div id="footer">made by wazder ❤</div>

  <script>
  window.onload = function() {
    function base64url(src) { return src.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
    function sha256(ver) { var s=new jsSHA('SHA-256','TEXT'); s.update(ver); return s.getHash('B64'); }
    var cryptoObj = window.crypto || window.msCrypto;
    var skipThreshold=3000, playlistOffset=null, trackOffset=null;
    var playlists=[], nextPlaylistsUrl,null, tracks=[], nextTracksUrl,null;
    var selPl='', playCtx='';
    var curIdx=0, curDur=0, updInt=null, showInfo=false, accessToken='';

    function fmt(ms) { var t=Math.floor(ms/1000),m=Math.floor(t/60),s=t%60;return (m<10?'0':'')+m+':'+(s<10?'0':'')+s; }
    function xhr(u,m,b,cb){ var r=new XMLHttpRequest(); r.open(m,u,true); if(accessToken)r.setRequestHeader('Authorization','Bearer '+accessToken); if(b)r.setRequestHeader('Content-Type','application/json'); r.onreadystatechange=function(){ if(r.readyState===4){ if(r.status>=200&&r.status<300)cb(null,JSON.parse(r.responseText));else cb(r.status);} }; r.send(b?JSON.stringify(b):null); }

    document.getElementById('loginBtn').onclick=function(){ alert('Login button clicked');
      var cid='46a1e07e779c46998b413317a78b8a26', rd=location.origin+location.pathname;
      var arr=new Uint8Array(64);cryptoObj.getRandomValues(arr);var v='';for(var i=0;i<64;i++){var h=arr[i].toString(16);v+=(h.length===1?'0':'')+h;}localStorage.setItem('spotify_code_verifier',v);
      var ch=base64url(sha256(v));
      location.href='https://accounts.spotify.com/authorize?response_type=code'+'&client_id='+encodeURIComponent(cid)+'&scope='+encodeURIComponent('playlist-read-private user-modify-playback-state user-read-playback-state')+'&redirect_uri='+encodeURIComponent(rd)+'&code_challenge_method=S256'+'&code_challenge='+encodeURIComponent(ch);
    };

    (function(){
      var p={};location.search.slice(1).split('&').forEach(function(x){var d=x.split('=');p[d[0]]=decodeURIComponent(d[1]||'');});
      if(!p.code)return;
      var cid='46a1e07e779c46998b413317a78b8a26', rd=location.origin+location.pathname;
      var v=localStorage.getItem('spotify_code_verifier');
      var b='grant_type=authorization_code'+'&code='+encodeURIComponent(p.code)+'&redirect_uri='+encodeURIComponent(rd)+'&client_id='+cid+'&code_verifier='+v;
      var rq=new XMLHttpRequest();rq.open('POST','https://accounts.spotify.com/api/token',true);rq.setRequestHeader('Content-Type','application/x-www-form-urlencoded');rq.onreadystatechange=function(){if(rq.readyState===4&&rq.status===200){accessToken=JSON.parse(rq.responseText).access_token;document.getElementById('loginContainer').style.display='none';document.getElementById('app').style.display='block';fetchPlaylists();}};rq.send(b);
    })();

    function fetchPlaylists(){xhr('https://api.spotify.com/v1/me/playlists?limit=50','GET',null,function(e,d){if(e)alert(e);playlists=d.items;renderPlaylists();});}
    function renderPlaylists(){var c=document.getElementById('playlistContainer');c.innerHTML='';playlists.forEach(function(pl,i){var d=document.createElement('div');d.className='item'+(pl.id===selPl?' selected':'');var s=document.createElement('span');s.textContent=pl.name;d.appendChild(s);d.onclick=function(){selPl=pl.id;tracks=[];renderPlaylists();fetchTracks(pl.id);};c.appendChild(d);});}

    function fetchTracks(pid){xhr('https://api.spotify.com/v1/playlists/'+pid+'/tracks?limit=50','GET',null,function(e,d){if(e)alert(e);tracks=d.items;renderTracks();});}
    function renderTracks(){var c=document.getElementById('trackContainer');c.innerHTML='';tracks.forEach(function(it,i){var d=document.createElement('div');d.className='item'+(i===curIdx?' playing':'');var s=document.createElement('span');s.textContent=it.track.name;d.appendChild(s);d.onclick=function(){play(i);};c.appendChild(d);});}

    function play(i){var t=tracks[i].track;curDur=t.duration_ms;xhr('https://api.spotify.com/v1/me/player/play','PUT',{context_uri:'spotify:playlist:'+selPl,offset:{position:i}},function(){curIdx=i;document.getElementById('nowTitle').textContent=t.name;document.getElementById('coverArt').style.backgroundImage='url('+t.album.images[0].url+')';document.getElementById('detailCover').style.backgroundImage='url('+t.album.images[0].url+')';updatePos();updInt=setInterval(updatePos,1000);});}
    function updatePos(){xhr('https://api.spotify.com/v1/me/player','GET',null,function(e,s){if(e)return;var el=s.progress_ms;document.getElementById('positionDisplay').textContent=fmt(el)+' / '+fmt(curDur);document.getElementById('progress').style.width=(el/curDur*100)+'%';});}

    document.getElementById('moreBtn').onclick=function(){var ic=document.getElementById('infoColumn'), tc=document.getElementById('trackColumn');tc.style.display=(tc.style.display==='none'?'block':'none');ic.style.display=(ic.style.display==='none'?'block':'none');};
    document.getElementById('prevBtn').onclick=function(){play((curIdx-1+tracks.length)%tracks.length);};
    document.getElementById('nextBtn').onclick=function(){play((curIdx+1)%tracks.length);};
  };
  </script>
</body>
</html>
