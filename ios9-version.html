<!-- ios9-version.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no" />
  <title>wazder's spotify controller</title>
  <link rel="icon" href="logo.png" />
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:Arial,sans-serif; }
    #loginContainer { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; transform:translateY(-20%); }
    #loginContainer h1 { margin-bottom:20px; font-size:2rem; text-align:center; }
    #loginBtn { padding:12px 24px; font-size:1.2rem; border:none; border-radius:4px; background-color:#1DB954; color:#fff; cursor:pointer; }
    #app { display:none; padding:20px; height:100%; box-sizing:border-box; }
    #nowPlaying { display:flex; align-items:center; background-color:#333; border-radius:8px; padding:10px; margin-bottom:20px; }
    #nowPlaying > * { margin-right:16px; }
    #nowPlaying > *:last-child { margin-right:0; }
    #coverArt { width:64px; height:64px; background-color:#222; border-radius:4px; background-size:cover; background-position:center; }
    #trackInfo h2 { margin:0; font-size:1.2rem; white-space:nowrap; overflow:hidden; }
    #positionDisplay { font-size:0.9rem; margin-top:4px; }
    #progressBar { width:400px; height:4px; background-color:#444; border-radius:2px; overflow:hidden; margin-top:8px; }
    #progress { width:0%; height:100%; background-color:#666; border-radius:2px; }
    #controls { display:flex; align-items:center; margin-left:auto; }
    #controls > * { margin-right:10px; }
    #controls > *:last-child { margin-right:0; }
    #moreBtn { padding:6px 12px; font-size:0.9rem; border:none; border-radius:4px; background-color:#555; color:#fff; cursor:pointer; }
    #prevBtn, #nextBtn { font-size:1.2rem; padding:8px; background:transparent; border:none; color:#fff; cursor:pointer; }
    #containers { display:flex; height:calc(100% - 140px); }
    #containers > .column { flex:1; background-color:#111; padding:10px; border-radius:4px; overflow-y:auto; margin-right:20px; }
    #containers > .column:last-child { margin-right:0; }
    .column h3 { margin-top:0; font-size:1rem; }
    .item { padding:8px; margin-bottom:4px; border:1px solid #333; border-radius:4px; cursor:pointer; display:flex; align-items:center; }
    .item.playing { background-color:#1DB954; color:#000; }
    .item.selected { border-color:brown; }
    .item span { display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
    .item .desc { color:rgba(255,255,255,0.3); margin-left:4px; }
    .show-more { display:block; width:100%; padding:8px; margin-top:8px; text-align:center; background:none; border:1px solid #1DB954; color:#1DB954; border-radius:4px; cursor:pointer; }
    #infoColumn { display:none; }
    #footer { position:fixed; bottom:10px; right:10px; font-size:0.8rem; color:rgba(255,255,255,0.3); pointer-events:none; z-index:1000; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.min.js"></script>
</head>
<body>
  <div id="loginContainer">
    <h1>welcome to wazder's spotify controller</h1>
    <button id="loginBtn">Spotify Login</button>
  </div>

  <div id="app">
    <div id="nowPlaying">
      <div id="coverArt"></div>
      <div id="trackInfo">
        <h2 id="nowTitle">—</h2>
        <div id="positionDisplay">00:00 / 00:00</div>
        <div id="progressBar"><div id="progress"></div></div>
      </div>
      <div id="controls">
        <button id="moreBtn">More</button>
        <button id="prevBtn">⏮</button>
        <button id="nextBtn">⏭</button>
      </div>
    </div>
    <div id="containers">
      <div class="column" id="playlistColumn">
        <h3>Playlists</h3>
        <div id="playlistContainer"></div>
        <button id="morePlaylistsBtn" class="show-more" style="display:none;">Show More</button>
      </div>
      <div class="column" id="trackColumn">
        <h3>Tracks</h3>
        <div id="trackContainer"></div>
        <button id="moreTracksBtn" class="show-more" style="display:none;">Show More</button>
      </div>
      <div class="column" id="infoColumn">
        <h3>Track Info</h3>
        <div id="detailCover" style="width:80%;padding-bottom:80%;background:#222;background-size:cover;background-position:center;border-radius:4px;margin:0 auto 10px;"></div>
        <p id="detailInfo">—</p>
      </div>
    </div>
  </div>

  <div id="footer">made by wazder ❤</div>

  <script>
    function base64url(source) {
      var b64 = source.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      return b64;
    }
    function sha256(verifier) {
      var shaObj = new jsSHA('SHA-256','TEXT');
      shaObj.update(verifier);
      return shaObj.getHash('B64');
    }

    var skipThreshold = 3000;
    var playlists = [], nextPlaylistsUrl = null;
    var tracks = [], nextTracksUrl = null;
    var selectedPlaylistId = '', playingContextUri = '';
    var currentIndex = 0, currentDurationMs = 0, updateInterval = null;
    var showInfoView = false;
    var accessToken = '';

    function formatMS(ms) {
      var totalSec = Math.floor(ms/1000);
      var m = Math.floor(totalSec/60);
      var s = totalSec % 60;
      return (m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    }
    function xhr(url, method, body, cb) {
      var req = new XMLHttpRequest();
      req.open(method,url,true);
      if(accessToken) req.setRequestHeader('Authorization','Bearer '+accessToken);
      if(body) req.setRequestHeader('Content-Type','application/json');
      req.onreadystatechange = function() {
        if(req.readyState===4) {
          if(req.status>=200&&req.status<300) cb(null,JSON.parse(req.responseText));
          else cb(new Error('HTTP '+req.status));
        }
      };
      req.send(body?JSON.stringify(body):null);
    }

    function updateView() {
      document.getElementById('trackColumn').style.display = showInfoView?'none':'block';
      document.getElementById('infoColumn').style.display = showInfoView?'block':'none';
    }
    document.getElementById('moreBtn').onclick = function(){ showInfoView=!showInfoView; updateView(); };

    (function(){
      var params = {};
      window.location.search.substring(1).split('&').forEach(function(p){
        var kv = p.split('='); params[kv[0]] = decodeURIComponent(kv[1]||'');
      });
      if(!params.code) return;
      var clientId='46a1e07e779c46998b413317a78b8a26';
      var redirectUri=window.location.origin+window.location.pathname;
      var verifier=localStorage.getItem('spotify_code_verifier');
      var body='grant_type=authorization_code'+'&code='+encodeURIComponent(params.code)
        +'&redirect_uri='+encodeURIComponent(redirectUri)
        +'&client_id='+clientId+'&code_verifier='+verifier;
      var req=new XMLHttpRequest();
      req.open('POST','https://accounts.spotify.com/api/token',true);
      req.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
      req.onreadystatechange=function(){
        if(req.readyState===4&&req.status===200){
          var data=JSON.parse(req.responseText);
          accessToken=data.access_token;
          document.getElementById('loginContainer').style.display='none';
          document.getElementById('app').style.display='block';
          fetchPlaylists();
          history.replaceState(null,'',window.location.pathname);
        }
      };
      req.send(body);
    })();

    document.getElementById('loginBtn').onclick=function(){
      var clientId='46a1e07e779c46998b413317a78b8a26';
      var redirectUri=window.location.origin+window.location.pathname;
      var arr=new Uint8Array(64);
      window.crypto.getRandomValues(arr);
      var verifier=''; for(var i=0;i<arr.length;i++){ var h=arr[i].toString(16); verifier+=(h.length===1?'0':'')+h; }
      localStorage.setItem('spotify_code_verifier',verifier);
      var challenge=base64url(sha256(verifier));
      window.location='https://accounts.spotify.com/authorize?response_type=code'
        +'&client_id='+encodeURIComponent(clientId)
        +'&scope='+encodeURIComponent('playlist-read-private user-modify-playback-state user-read-playback-state')
        +'&redirect_uri='+encodeURIComponent(redirectUri)
        +'&code_challenge_method=S256'
        +'&code_challenge='+encodeURIComponent(challenge);
    };

    function fetchPlaylists(url) { xhr(url||'https://api.spotify.com/v1/me/playlists?limit=50','GET',null,function(err,data){ if(err) return alert('Playlist yüklenemedi: '+err); playlists=playlists.concat(data.items); nextPlaylistsUrl=data.next; renderPlaylists(); document.getElementById('morePlaylistsBtn').style.display=nextPlaylistsUrl?'block':'none'; }); }
    document.getElementById('morePlaylistsBtn').onclick=function(){ fetchPlaylists(nextPlaylistsUrl); };

    function renderPlaylists() {
      var c=document.getElementById('playlistContainer'); c.innerHTML=''; playlists.forEach(function(pl){
        var div=document.createElement('div');
        div.className='item'+(pl.id===selectedPlaylistId?' selected':'')+(pl.id===playingContextUri?' playing':'');
        var span=document.createElement('span'); span.textContent=pl.name;
        div.appendChild(span); div.onclick=function(){ selectPlaylist(pl); }; c.appendChild(div);
      });
    }

    function selectPlaylist(pl) { selectedPlaylistId=pl.id; tracks=[]; nextTracksUrl=null; showInfoView=false; updateView(); renderPlaylists(); fetchTracks('https://api.spotify.com/v1/playlists/'+pl.id+'/tracks?limit=50'); }

    function fetchTracks(url) { xhr(url,'GET',null,function(err,data){ if(err) return alert('Şarkılar yüklenemedi: '+err); tracks=tracks.concat(data.items); nextTracksUrl=data.next; renderTracks(); document.getElementById('moreTracksBtn').style.display=nextTracksUrl?'block':'none'; }); }
    document.getElementById('moreTracksBtn').onclick=function(){ fetchTracks(nextTracksUrl); };

    function renderTracks() { var c=document.getElementById('trackContainer'); document.querySelector('#trackColumn h3').textContent='Tracks ('+tracks.length+')'; c.innerHTML=''; tracks.forEach(function(i,idx){ var t=i.track; var div=document.createElement('div'); div.className='item'+(idx===currentIndex?' playing':''); var span=document.createElement('span'); span.textContent=t.name; div.appendChild(span); div.onclick=function(){ playTrack(idx); }; c.appendChild(div); }); }

    function playTrack(idx) { var t=tracks[idx].track; currentDurationMs=t.duration_ms; xhr('https://api.spotify.com/v1/me/player/play','PUT',{ context_uri:'spotify:playlist:'+selectedPlaylistId, offset:{position:idx} }, function(err){ if(err) return; playingContextUri=selectedPlaylistId; currentIndex=idx; document.getElementById('nowTitle').textContent=t.name; var detailLine=t.artists.map(function(a){return a.name;}).join(', ')+ ' / '+t.album.name+' / '+t.name; document.getElementById('detailCover').style.backgroundImage='url('+t.album.images[0].url+')'; document.getElementById('coverArt').style.backgroundImage='url('+t.album.images[0].url+')'; document.getElementById('detailInfo').textContent=detailLine; renderPlaylists(); renderTracks(); clearInterval(updateInterval); document.getElementById('positionDisplay').textContent='00:00 / '+formatMS(t.duration_ms); updateInterval=setInterval(updatePosition,1000); }); }

    function updatePosition() { xhr('https://api.spotify.com/v1/me/player','GET',null,function(err,state){ if(err) return; var elapsed=state.progress_ms||0; if(elapsed>=currentDurationMs-skipThreshold){ clearInterval(updateInterval); playTrack((currentIndex+1)%tracks.length); return; } document.getElementById('positionDisplay').textContent=formatMS(elapsed)+' / '+formatMS(currentDurationMs); document.getElementById('progress').style.width=(elapsed/currentDurationMs*100)+'%'; }); }

    document.getElementById('prevBtn').onclick=function(){ playTrack((currentIndex-1+tracks.length)%tracks.length); };
    document.getElementById('nextBtn').onclick=function(){ playTrack((currentIndex+tracks.length)%tracks.length); };
  </script>
</body>
</html>
